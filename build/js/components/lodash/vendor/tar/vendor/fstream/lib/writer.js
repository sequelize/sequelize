function Writer(e,t){var n=this;typeof e=="string"&&(e={path:e}),e.path||n.error("Must provide a path",null,!0);var r=getType(e),i=Writer;switch(r){case"Directory":i=DirWriter;break;case"File":i=FileWriter;break;case"Link":case"SymbolicLink":i=LinkWriter;break;case null:i=ProxyWriter}if(!(n instanceof i))return new i(e);Abstract.call(n),n.type=e.type,n.props=e,n.depth=e.depth||0,n.clobber=!1===e.clobber?e.clobber:!0,n.parent=e.parent||null,n.root=e.root||e.parent&&e.parent.root||n,n._path=n.path=path.resolve(e.path),process.platform==="win32"&&(n.path=n._path=n.path.replace(/\?/g,"_"),n._path.length>=260&&(n._swallowErrors=!0,n._path="\\\\?\\"+n.path.replace(/\//g,"\\"))),n.basename=path.basename(e.path),n.dirname=path.dirname(e.path),n.linkpath=e.linkpath||null,e.parent=e.root=null,n.size=e.size,typeof e.mode=="string"&&(e.mode=parseInt(e.mode,8)),n.readable=!1,n.writable=!0,n._buffer=[],n.ready=!1,n.filter=typeof e.filter=="function"?e.filter:null,n._stat(t)}function create(e){mkdir(path.dirname(e._path),Writer.dirmode,function(t,n){return t?e.error(t):(e._madeDir=n,e._create())})}function endChmod(e,t,n,r,i){var s=t.mode,o=t.follow||e.type!=="SymbolicLink"?"chmod":"lchmod";if(!fs[o])return i();if(typeof s!="number")return i();var u=n.mode&511;s&=511;if(s===u)return i();fs[o](r,s,i)}function endChown(e,t,n,r,i){if(process.platform==="win32")return i();if(!process.getuid||!process.getuid()===0)return i();if(typeof t.uid!="number"&&typeof t.gid!="number")return i();if(n.uid===t.uid&&n.gid===t.gid)return i();var s=e.props.follow||e.type!=="SymbolicLink"?"chown":"lchown";if(!fs[s])return i();typeof t.uid!="number"&&(t.uid=n.uid),typeof t.gid!="number"&&(t.gid=n.gid),fs[s](r,t.uid,t.gid,i)}function endUtimes(e,t,n,r,i){if(!fs.utimes||process.platform==="win32")return i();var s=t.follow||e.type!=="SymbolicLink"?"utimes":"lutimes";s==="lutimes"&&!fs[s]&&(s="utimes");if(!fs[s])return i();var o=n.atime,u=n.mtime,a=t.atime,f=t.mtime;a===undefined&&(a=o),f===undefined&&(f=u),isDate(a)||(a=new Date(a)),isDate(f)||(a=new Date(f));if(a.getTime()===o.getTime()&&f.getTime()===u.getTime())return i();fs[s](r,a,f,i)}function endMadeDir(e,t,n){var r=e._madeDir,i=path.dirname(t);endMadeDir_(e,i,function(t){if(t)return n(t);if(i===r)return n();endMadeDir(e,i,n)})}function endMadeDir_(e,t,n){function o(e){if(s)return;if(e)return n(s=e);if(--i===0)return n()}var r={};Object.keys(e.props).forEach(function(t){r[t]=e.props[t],t==="mode"&&e.type!=="Directory"&&(r[t]=r[t]|73)});var i=3,s=null;fs.stat(t,function(i,u){if(i)return n(s=i);endChmod(e,r,u,t,o),endChown(e,r,u,t,o),endUtimes(e,r,u,t,o)})}function objectToString(e){return Object.prototype.toString.call(e)}function isDate(e){return typeof e=="object"&&objectToString(e)==="[object Date]"}module.exports=Writer;var fs=require("../../graceful-fs/graceful-fs.js"),inherits=require("../../inherits/inherits.js"),rimraf=require("../../rimraf/rimraf.js"),mkdir=require("../../mkdirp"),path=require("path"),umask=process.platform==="win32"?0:process.umask(),getType=require("./get-type.js"),Abstract=require("./abstract.js");inherits(Writer,Abstract),Writer.dirmode=511&~umask,Writer.filemode=438&~umask;var DirWriter=require("./dir-writer.js"),LinkWriter=require("./link-writer.js"),FileWriter=require("./file-writer.js"),ProxyWriter=require("./proxy-writer.js");Writer.prototype._create=function(){var e=this;fs[e.props.follow?"stat":"lstat"](e._path,function(t,n){if(t)return e.warn("Cannot create "+e._path+"\n"+"Unsupported type: "+e.type,"ENOTSUP");e._finish()})},Writer.prototype._stat=function(e){function s(e,n){if(t.filter&&!t.filter.call(i,i,n)){t._aborted=!0,t.emit("end"),t.emit("close");return}if(e||!n)return create(t);t._old=n;var r=getType(n);if(r!==t.type)return rimraf(t._path,function(e){if(e)return t.error(e);t._old=null,create(t)});create(t)}var t=this,n=t.props,r=n.follow?"stat":"lstat",i=t._proxy||t;e?s(null,e):fs[r](t._path,s)},Writer.prototype._finish=function(){function s(t){endChmod(e,e.props,t,e._path,o("chmod")),endChown(e,e.props,t,e._path,o("chown")),endUtimes(e,e.props,t,e._path,o("chown"))}function o(i){return t++,function(s){function o(t){if(t)return t.fstream_finish_call="setupMadeDir",e.error(t);e.emit("end"),e.emit("close")}if(n)return;if(s)return s.fstream_finish_call=i,e.error(n=s);if(--t>0)return;if(r)return;r=!0;if(!e._madeDir)return o();endMadeDir(e,e._path,o)}}var e=this,t=0,n=null,r=!1;if(e._old)e._old.atime=new Date(0),e._old.mtime=new Date(0),s(e._old);else{var i=e.props.follow?"stat":"lstat";fs[i](e._path,function(t,n){if(t){if(t.code!=="ENOENT"||e.type!=="Link"&&e.type!=="SymbolicLink"||process.platform!=="win32")return e.error(t);e.ready=!0,e.emit("ready"),e.emit("end"),e.emit("close"),e.end=e._finish=function(){};return}s(e._old=n)})}return},Writer.prototype.pipe=function(){this.error("Can't pipe from writable stream")},Writer.prototype.add=function(){this.error("Cannot add to non-Directory type")},Writer.prototype.write=function(){return!0};